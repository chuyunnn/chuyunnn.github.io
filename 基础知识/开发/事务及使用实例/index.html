<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="ACID特性 原子性 Atomicity：事务包含的所有操作要么全部成功，要么全部失败回滚 一致性 Consistency：事务执行前后数据库的状态保持一致，比如库存、金额总额一致 隔离型 Isolation：多个用户并发访问数据库时，事务直接不会互相干扰 持久性 Durability：事务一旦提交，数据库中数据改变是持久的，即使数据库故障也不会丢失事务操作  数据库事务的实现原理MySQL的In">
<meta property="og:type" content="article">
<meta property="og:title" content="事务及使用实例">
<meta property="og:url" content="http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ACID特性 原子性 Atomicity：事务包含的所有操作要么全部成功，要么全部失败回滚 一致性 Consistency：事务执行前后数据库的状态保持一致，比如库存、金额总额一致 隔离型 Isolation：多个用户并发访问数据库时，事务直接不会互相干扰 持久性 Durability：事务一旦提交，数据库中数据改变是持久的，即使数据库故障也不会丢失事务操作  数据库事务的实现原理MySQL的In">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2026-01-22T06:47:40.000Z">
<meta property="article:modified_time" content="2026-01-22T11:26:04.802Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="实例">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>事务及使用实例</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/redis-%E5%AE%9E%E4%BE%8B/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/MapStruct/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&text=事务及使用实例"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&is_video=false&description=事务及使用实例"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=事务及使用实例&body=Check out this article: http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&name=事务及使用实例&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&t=事务及使用实例"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ACID%E7%89%B9%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text">ACID特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">数据库事务的实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">2.1.</span> <span class="toc-text">数据库事务的隔离级别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E4%BA%8B%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">redis事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%9A%E4%BD%BF%E7%94%A8-Transactional"><span class="toc-number">4.1.</span> <span class="toc-text">声明式事务：使用@Transactional</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BF%AE%E9%A5%B0%E4%BD%8D%E7%BD%AE"><span class="toc-number">4.1.1.</span> <span class="toc-text">1. 修饰位置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0"><span class="toc-number">4.1.2.</span> <span class="toc-text">2. 参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">4.2.</span> <span class="toc-text">编程式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B3%A8%E5%85%A5-TransactionTemplate"><span class="toc-number">4.2.1.</span> <span class="toc-text">1. 注入 TransactionTemplate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%94%A8-transactionTemplate-execute-%E5%8C%85%E8%A3%B9%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="toc-number">4.2.2.</span> <span class="toc-text">2. 用 transactionTemplate.execute() 包裹业务逻辑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8B-%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">4.3.</span> <span class="toc-text">📋 使用注意事项</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        事务及使用实例
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2026-01-22T06:47:40.000Z" class="dt-published" itemprop="datePublished">2026-01-22</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">基础知识</a> › <a class="category-link" href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/">开发</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/%E5%AE%9E%E4%BE%8B/" rel="tag">实例</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="ACID特性"><a href="#ACID特性" class="headerlink" title="ACID特性"></a>ACID特性</h2><ul>
<li><strong>原子性 Atomicity：</strong>事务包含的所有操作<strong>要么全部成功，要么全部失败回滚</strong></li>
<li><strong>一致性 Consistency：</strong>事务执行前后数据库的状态保持一致，比如库存、金额总额一致</li>
<li><strong>隔离型 Isolation：</strong>多个用户并发访问数据库时，事务直接不会互相干扰</li>
<li><strong>持久性 Durability：</strong>事务一旦提交，数据库中数据改变是持久的，即使数据库故障也不会丢失事务操作</li>
</ul>
<h2 id="数据库事务的实现原理"><a href="#数据库事务的实现原理" class="headerlink" title="数据库事务的实现原理"></a>数据库事务的实现原理</h2><p>MySQL的InnoDB引擎：</p>
<ul>
<li>使用redo log（重做日志）保证持久性</li>
<li>使用undo log（回滚日志）保证原子性</li>
<li>使用锁机制、MVCC保证隔离性</li>
</ul>
<p>&#x3D;&#x3D;&gt; 隔离级别：repeatable read 可重复读</p>
<h3 id="数据库事务的隔离级别"><a href="#数据库事务的隔离级别" class="headerlink" title="数据库事务的隔离级别"></a>数据库事务的隔离级别</h3><ul>
<li>读未提交 read uncommitted：别人改了一半也能看到 &#x3D;&#x3D;&gt; 脏读</li>
<li>读已提交 read committed：读已经发布的内容 &#x3D;&#x3D;&gt; 不可重复读（不可用于要求数据一致性场景 行锁）</li>
<li>可重复读 repeatable read（SQL默认）：读到任务开始时读快照 &#x3D;&#x3D;&gt; 幻读（间隙锁）</li>
<li>串行化 serializable：独占锁，其余事务不可读不可写，排队等待当前食物结束（表锁，避免所有并发问题，性能差）</li>
</ul>
<h2 id="redis事务"><a href="#redis事务" class="headerlink" title="redis事务"></a>redis事务</h2><p>将多个命令请求打包，顺序执行打包的命令，并且不被打断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MULTI --&gt; (放指令) ... --&gt; EXEC(开始执行)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>不支持原子性</strong>：redis事务不支持回滚，也就是事务中的指令如果没有出错的话是会正常执行掉的</p>
</li>
<li><p><strong>不支持持久性</strong>：redis的持久化方式为：快照RDB+AOF。其中AOF比RDB的实时性更好，有三种模式</p>
<ul>
<li><p>always：每次有数据修改都同步AOF</p>
</li>
<li><p>everysec：每秒同步一次</p>
</li>
<li><p>no：让操作系统决定多长时间同步一次（一般为30秒）</p>
<p>这里everysec、no都<u>存在数据丢失的情况</u>，所以不支持持久性</p>
</li>
</ul>
</li>
</ul>
<p>解决redis事务的缺陷方法：使用Lua脚本 &#x3D;&#x3D;&gt; 它是<strong>原子操作</strong>，也就是批量执行多条redis命令，一段Lua脚本执行时不会有其余脚本&#x2F;redis命令同时执行。但是Lua脚本也不能回滚（原子操作 !&#x3D; 原子性）</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="声明式事务：使用-Transactional"><a href="#声明式事务：使用-Transactional" class="headerlink" title="声明式事务：使用@Transactional"></a>声明式事务：使用<code>@Transactional</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存文章，当articleId存在时，表示更新记录；不存在时，表示插入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 指定所有异常（包括运行时异常和检查型异常）都会触发回滚</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">saveArticle</span><span class="params">(ArticlePostReq req, Long author)</span> &#123;</span><br><span class="line">    <span class="type">ArticleDO</span> <span class="variable">article</span> <span class="operator">=</span> ArticleConverter.toArticleDo(req, author);</span><br><span class="line">    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> imageService.mdImgReplace(req.getContent());</span><br><span class="line">    <span class="keyword">if</span> (NumUtil.nullOrZero(req.getArticleId())) &#123;</span><br><span class="line">        <span class="keyword">return</span> insertArticle(article, content, req.getTagIds());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> updateArticle(article, content, req.getTagIds());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-修饰位置"><a href="#1-修饰位置" class="headerlink" title="1. 修饰位置"></a>1. 修饰位置</h4><ul>
<li>方法上添加注解</li>
<li>类上添加注解：类中所有**<u>公共方法</u>**都支持事务</li>
</ul>
<h4 id="2-参数"><a href="#2-参数" class="headerlink" title="2. 参数"></a>2. 参数</h4><table>
<thead>
<tr>
<th align="center">属性名</th>
<th align="center">类型</th>
<th align="center">核心作用</th>
<th align="center">默认值</th>
<th align="center">常用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>value</code>&#x2F;<code>transactionManager</code></td>
<td align="center">String</td>
<td align="center">指定事务管理器</td>
<td align="center">容器默认的事务管理器</td>
<td align="center">多数据源 &#x2F; 多事务管理器场景</td>
</tr>
<tr>
<td align="center"><code>propagation</code></td>
<td align="center">Propagation</td>
<td align="center">事务传播行为 &#x3D;&#x3D;&gt;  当一个有事务的方法调用另一个方法时，事务该如何传递</td>
<td align="center">REQUIRED</td>
<td align="center">嵌套调用时控制事务创建规则</td>
</tr>
<tr>
<td align="center"><code>isolation</code></td>
<td align="center">Isolation</td>
<td align="center"><strong>事务隔离级别</strong></td>
<td align="center">DEFAULT（数据库默认）</td>
<td align="center">解决脏读 &#x2F; 不可重复读 &#x2F; 幻读</td>
</tr>
<tr>
<td align="center"><code>timeout</code></td>
<td align="center">int</td>
<td align="center">事务超时时间（秒）</td>
<td align="center">-1（永不超时）</td>
<td align="center">防止长事务占用资源</td>
</tr>
<tr>
<td align="center"><code>readOnly</code></td>
<td align="center">boolean</td>
<td align="center">是否只读事务</td>
<td align="center">false</td>
<td align="center">纯查询操作，优化性能</td>
</tr>
<tr>
<td align="center"><code>rollbackFor</code></td>
<td align="center">Class&lt;? extends Throwable&gt;[]</td>
<td align="center"><strong>指定触发回滚的异常类型</strong></td>
<td align="center">仅运行时异常（RuntimeException）</td>
<td align="center">需要捕获检查型异常并回滚</td>
</tr>
<tr>
<td align="center"><code>rollbackForClassName</code></td>
<td align="center">String[]</td>
<td align="center">同上（异常类名）</td>
<td align="center">-</td>
<td align="center">不想引入异常类时使用</td>
</tr>
<tr>
<td align="center"><code>noRollbackFor</code></td>
<td align="center">Class&lt;? extends Throwable&gt;[]</td>
<td align="center"><strong>指定不回滚的异常类型</strong></td>
<td align="center">-</td>
<td align="center">特定异常不希望回滚</td>
</tr>
<tr>
<td align="center"><code>noRollbackForClassName</code></td>
<td align="center">String[]</td>
<td align="center">同上（异常类名）</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody></table>
<p>🌟注意<code>rollbackFor</code>：不指定具体异常时，默认只有**<u>运行时</u>异常**才会触发事务回滚</p>
<hr>
<ul>
<li><p>运行时异常：代码逻辑问题，不需要<code>try-catch</code>显示捕获</p>
</li>
<li><p>检查型异常：外部资源异常（IO、网络、数据库连接），需要<code>try-catch</code>显示捕获或声明抛出<code>throws</code></p>
</li>
</ul>
<hr>
<h3 id="编程式事务"><a href="#编程式事务" class="headerlink" title="编程式事务"></a>编程式事务</h3><p>声明式事务的约束：最小粒度为方法级别，如果想在**<u>方法内部分代码块</u>**进行事务约束，可用编程式事务</p>
<p>&#x3D;&#x3D;&gt; 比如要下载图片并上传这种耗时操作不需要加入事务</p>
<p>🌟 使用事务时牢记：<em><strong>最小范围使用原则</strong></em></p>
<h4 id="1-注入-TransactionTemplate"><a href="#1-注入-TransactionTemplate" class="headerlink" title="1. 注入 TransactionTemplate"></a>1. 注入 <code>TransactionTemplate</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TransactionTemplate transactionTemplate;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>TransactionTemplate</code> 是Spring提供的编程式事务工具类，封装了事务的开启、提交、回滚等操作</p>
</li>
<li><p>它会自动使用 Spring 容器中的事务管理器，无需手动配置</p>
</li>
</ul>
<h4 id="2-用-transactionTemplate-execute-包裹业务逻辑"><a href="#2-用-transactionTemplate-execute-包裹业务逻辑" class="headerlink" title="2. 用 transactionTemplate.execute() 包裹业务逻辑"></a>2. 用 <code>transactionTemplate.execute()</code> 包裹业务逻辑</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 将逻辑改造为编程式事务</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">saveArticle</span><span class="params">(ArticlePostReq req, Long author)</span> &#123;</span><br><span class="line">    <span class="type">ArticleDO</span> <span class="variable">article</span> <span class="operator">=</span> ArticleConverter.toArticleDo(req, author);</span><br><span class="line">    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> imageService.mdImgReplace(req.getContent());</span><br><span class="line">    <span class="keyword">return</span> transactionTemplate.execute(<span class="keyword">new</span> <span class="title class_">TransactionCallback</span>&lt;Long&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Long <span class="title function_">doInTransaction</span><span class="params">(TransactionStatus status)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (NumUtil.nullOrZero(req.getArticleId())) &#123;</span><br><span class="line">                <span class="keyword">return</span> insertArticle(article, content, req.getTagIds());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> updateArticle(article, content, req.getTagIds());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>execute()</code> 方法接收一个 <code>TransactionCallback</code> 回调，回调中的 <code>doInTransaction()</code> 方法会在事务内执行</p>
</li>
<li><p>如果 <code>doInTransaction()</code> 正常返回，Spring 会自动提交事务；如果抛出异常，会自动回滚事务</p>
</li>
<li><p><code>TransactionStatus</code> 对象可以用来手动控制事务（比如 <code>status.setRollbackOnly()</code> 强制回滚）</p>
</li>
</ul>
<h3 id="📋-使用注意事项"><a href="#📋-使用注意事项" class="headerlink" title="📋 使用注意事项"></a>📋 使用注意事项</h3><ol>
<li>使用场景</li>
</ol>
<p>首先确定事务的使用场景，什么时候要用事务，不要瞎用，就比如非常简单的只读场景，那么什么场景需要用呢？</p>
<ul>
<li>当一个基础的业务单元 (如对外提供的 http 接口，service 方法)，存在 &gt;&#x3D;2 的数据变更时，就需要考虑，部分更新成功，部分更新失败是否会出现脏数据，是否会有影响。<ul>
<li>若是：则可以考虑引入事务</li>
<li>若否：不建议加入事务</li>
</ul>
</li>
<li>只有一个数据变更，但是后续有强依赖这个数据的逻辑，也需要加入事务<ul>
<li>比如接到支付成功消息，我要做一个校对的后台任务</li>
<li>我的业务逻辑是：先调用第三方校验是否属实，然后更新本地状态为成功，最后 MQ 方式通知订单状态变更</li>
<li>此时我们需要将第二步数据变更与第三步消息通知放在事务中，只要通知失败，我们还是不更新本地状态，避免出现我们校验成功了，但是订单还是未支付</li>
</ul>
</li>
</ul>
<ol start="2">
<li>使用建议</li>
</ol>
<ul>
<li>避免大事务，只在需要的地方加事务</li>
<li>注意分布式事务场景</li>
<li>所有的操作，走索引，避免出现锁表</li>
<li>减少范围、大批量的数据处理场景</li>
<li>如果业务支撑，可以降低隔离级别，一是减少隔离级别带来的附加成本，二则是可以避免某些场景下的死锁</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/101-jdbctemplate-transaction">https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/101-jdbctemplate-transaction</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ACID%E7%89%B9%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text">ACID特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">数据库事务的实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">2.1.</span> <span class="toc-text">数据库事务的隔离级别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E4%BA%8B%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">redis事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%9A%E4%BD%BF%E7%94%A8-Transactional"><span class="toc-number">4.1.</span> <span class="toc-text">声明式事务：使用@Transactional</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BF%AE%E9%A5%B0%E4%BD%8D%E7%BD%AE"><span class="toc-number">4.1.1.</span> <span class="toc-text">1. 修饰位置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0"><span class="toc-number">4.1.2.</span> <span class="toc-text">2. 参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">4.2.</span> <span class="toc-text">编程式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B3%A8%E5%85%A5-TransactionTemplate"><span class="toc-number">4.2.1.</span> <span class="toc-text">1. 注入 TransactionTemplate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%94%A8-transactionTemplate-execute-%E5%8C%85%E8%A3%B9%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="toc-number">4.2.2.</span> <span class="toc-text">2. 用 transactionTemplate.execute() 包裹业务逻辑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8B-%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">4.3.</span> <span class="toc-text">📋 使用注意事项</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&text=事务及使用实例"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&is_video=false&description=事务及使用实例"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=事务及使用实例&body=Check out this article: http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&title=事务及使用实例"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&name=事务及使用实例&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%BC%80%E5%8F%91/%E4%BA%8B%E5%8A%A1%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/&t=事务及使用实例"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2026
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
